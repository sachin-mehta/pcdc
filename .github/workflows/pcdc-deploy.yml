name: PCDC Build & Release

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (prod or dev)'
        required: true
        default: 'dev'
      fix_types:
        description: 'Run type-fix script to patch files (true/false)'
        required: false
        default: 'false'
      retention_days:
        description: 'Artifact retention days for dev builds'
        required: false
        default: '7'

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'

      - name: Install root dependencies
        run: npm ci

      - name: Optional Run type-fix script
        if: ${{ github.event.inputs.fix_types == 'true' }}
        run: |
          echo "Running modify-lines to fix known type errors..."
          node scripts/modify-lines.js --dir . --match "// @ts-ignore" --replace "// @ts-ignore"

      - name: Create environment-specific file
        run: |
          echo "Creating environment file for ${{ github.event.inputs.environment }}"
          if ($env:GITHUB_EVENT_INPUTS_environment -eq 'prod') {
            node -e "const fs=require('fs'); fs.writeFileSync('src/environments/_environment.prod.ts', 'export const environment = { production: true, name: \"prod\" };\n');"
          } else {
            node -e "const fs=require('fs'); fs.writeFileSync('src/environments/_environment.prod.ts', 'export const environment = { production: false, name: \"dev\" };\n');"
          }
        shell: pwsh

      - name: Build Angular app
        run: |
          echo "Building Angular app (production when environment=prod)"
          if ($env:GITHUB_EVENT_INPUTS_environment -eq 'prod') { npm run build -- --configuration production } else { npm run build }
        shell: pwsh

      - name: Build Electron (.exe)
        working-directory: ./electron
        run: |
          npm ci
          npm run electron:make
        shell: pwsh

      - name: Find produced .exe
        id: find-exe
        run: |
          $exe = Get-ChildItem -Path . -Recurse -Filter *.exe | Select-Object -First 1 -ExpandProperty FullName
          if (-not $exe) { Write-Error 'No .exe found'; exit 2 }
          echo "exe=$exe" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh

      - name: Production create prerelease and upload .exe
        if: ${{ github.event.inputs.environment == 'prod' }}
        uses: actions/create-release@v1
        id: create_release
        with:
          tag_name: release-${{ github.run_number }}-${{ github.sha }}
          release_name: PCDC-prod-${{ github.run_number }}
          body: Automated production build (prerelease)
          draft: false
          prerelease: true

      - name: Production upload .exe to release
        if: ${{ github.event.inputs.environment == 'prod' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find-exe.outputs.exe }}
          asset_name: pcdc-installer.exe
          asset_content_type: application/octet-stream

      - name: Development upload .exe as artifact
        if: ${{ github.event.inputs.environment != 'prod' }}
        uses: actions/upload-artifact@v4
        with:
          name: pcdc-windows-exe
          path: '**/*.exe'
          retention-days: ${{ github.event.inputs.retention_days }}
